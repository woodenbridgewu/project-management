<div class="task-detail-container">
  <div class="page-actions" *ngIf="!isEditing">
    <button class="btn-secondary" (click)="toggleEditMode()">
      âœï¸ ç·¨è¼¯
    </button>
    <button class="btn-danger" (click)="deleteTask()">
      ğŸ—‘ï¸ åˆªé™¤
    </button>
  </div>

  @if (loading()) {
    <div class="loading">è¼‰å…¥ä¸­...</div>
  } @else if (task()) {
    <div class="task-detail-content">
      <!-- ä»»å‹™åŸºæœ¬è³‡è¨Š -->
      <app-task-info
        [task]="task()"
        [workspaceMembers]="workspaceMembers"
        [isEditing]="isEditing"
        [editForm]="editForm"
        (editFormChange)="onEditFormChange($event)"
        (dueDateChange)="onDueDateChange($event)"
      ></app-task-info>

      <!-- å­ä»»å‹™å€å¡Š -->
      <app-task-subtasks
        [taskId]="taskId"
        [isEditing]="isEditing"
        (taskUpdated)="loadTask()"
        (activitiesRefresh)="loadActivitiesFirstPage()"
      ></app-task-subtasks>

      <!-- æ¨™ç±¤å€å¡Š -->
      <app-task-tags
        [task]="task()"
        [taskId]="taskId"
        [workspaceId]="workspaceId"
        [presetColors]="presetColors"
        (taskUpdated)="loadTask()"
        (activitiesRefresh)="loadActivitiesFirstPage()"
      ></app-task-tags>

      <!-- ç·¨è¼¯æ¨¡å¼æŒ‰éˆ• -->
      @if (isEditing) {
        <div class="edit-actions">
          <button class="btn-secondary" (click)="cancelEdit()">å–æ¶ˆ</button>
          <button class="btn-primary" (click)="saveTask()" [disabled]="saving() || !editForm.title">
            {{ saving() ? 'å„²å­˜ä¸­...' : 'å„²å­˜' }}
          </button>
        </div>
      }

      <!-- é™„ä»¶å€å¡Š -->
      <app-task-attachments
        [taskId]="taskId"
        [isEditing]="isEditing"
        (taskUpdated)="loadTask()"
        (activitiesRefresh)="loadActivitiesFirstPage()"
      ></app-task-attachments>

      <!-- æ´»å‹•ç´€éŒ„å€å¡Š -->
      <app-task-activities
        [taskId]="taskId"
        [isEditing]="isEditing"
      ></app-task-activities>

      <!-- è©•è«–å€å¡Š -->
      <app-task-comments
        [taskId]="taskId"
        [projectId]="task()?.project_id || ''"
        [isEditing]="isEditing"
        (activitiesRefresh)="loadActivitiesFirstPage()"
      ></app-task-comments>
    </div>
  } @else {
    <div class="error-state">
      <p>ä»»å‹™ä¸å­˜åœ¨æˆ–è¼‰å…¥å¤±æ•—</p>
      <button class="btn-primary" (click)="goBack()">è¿”å›</button>
    </div>
  }
</div>
