<div class="tags-section">
  <div class="section-header">
    <h3 class="section-title">æ¨™ç±¤</h3>
    <div class="header-actions">
      <button class="btn-link" (click)="showTagModal = true">+ æ–°å¢æ¨™ç±¤</button>
      <button class="btn-link" (click)="showManageTagsModal = true">ç®¡ç†æ¨™ç±¤</button>
    </div>
  </div>
  
  <!-- ä»»å‹™æ¨™ç±¤åˆ—è¡¨ -->
  <div class="task-tags-list">
    @for (tag of task?.tags || []; track tag.id) {
      <span 
        class="tag-badge" 
        [style.background-color]="tag.color"
        [style.color]="getContrastColor(tag.color)"
      >
        {{ tag.name }}
        <button 
          class="tag-remove" 
          (click)="removeTagFromTask(tag.id)"
          [style.color]="getContrastColor(tag.color)"
        >
          Ã—
        </button>
      </span>
    } @empty {
      <span class="no-tags">å°šç„¡æ¨™ç±¤</span>
    }
  </div>

  <!-- æ·»åŠ æ¨™ç±¤ -->
  @if (availableTags().length > 0) {
    <div class="add-tag-section">
      <label>æ·»åŠ æ¨™ç±¤</label>
      <div class="available-tags">
        @for (tag of availableTags(); track tag.id) {
          @if (!isTagAttached(tag.id)) {
            <button 
              class="tag-option"
              [style.background-color]="tag.color"
              [style.color]="getContrastColor(tag.color)"
              (click)="addTagToTask(tag.id)"
            >
              {{ tag.name }}
            </button>
          }
        }
      </div>
    </div>
  }
</div>

<!-- æ–°å¢æ¨™ç±¤æ¨¡æ…‹æ¡† -->
<div class="modal-overlay" *ngIf="showTagModal" (click)="closeTagModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>æ–°å¢æ¨™ç±¤</h2>
      <button class="btn-close" (click)="closeTagModal()">Ã—</button>
    </div>
    <form (ngSubmit)="createTag()" class="modal-form">
      <div class="form-group">
        <label for="tag-name">åç¨± *</label>
        <input 
          type="text" 
          id="tag-name" 
          [value]="newTagForm.name"
          (input)="onNewTagFormChange('name', $any($event.target).value)"
          name="tag-name"
          required
          placeholder="è¼¸å…¥æ¨™ç±¤åç¨±"
          maxlength="100"
        />
      </div>
      <div class="form-group">
        <label for="tag-color">é¡è‰²</label>
        <!-- é è¨­é¡è‰²é¸é … -->
        <div class="preset-colors">
          @for (presetColor of presetColors; track presetColor) {
            <button
              type="button"
              class="preset-color-btn"
              [class.active]="newTagForm.color === presetColor"
              [style.background-color]="presetColor"
              (click)="onNewTagFormChange('color', presetColor)"
              [title]="presetColor"
            >
              @if (newTagForm.color === presetColor) {
                <span class="check-icon">âœ“</span>
              }
            </button>
          }
        </div>
        <!-- è‡ªè¨‚é¡è‰²é¸æ“‡å™¨ -->
        <div class="color-picker-group">
          <input 
            type="color" 
            id="tag-color" 
            [value]="newTagForm.color"
            (input)="onNewTagFormChange('color', $any($event.target).value)"
            name="tag-color"
          />
          <input 
            type="text" 
            [value]="newTagForm.color"
            (input)="onNewTagFormChange('color', $any($event.target).value)"
            name="tag-color-hex"
            placeholder="#808080"
            pattern="^#[0-9A-Fa-f]{6}$"
          />
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeTagModal()">å–æ¶ˆ</button>
        <button type="submit" class="btn-primary" [disabled]="savingTag() || !newTagForm.name.trim()">
          {{ savingTag() ? 'å»ºç«‹ä¸­...' : 'å»ºç«‹' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ç®¡ç†æ¨™ç±¤æ¨¡æ…‹æ¡† -->
<div class="modal-overlay" *ngIf="showManageTagsModal" (click)="closeManageTagsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ç®¡ç†æ¨™ç±¤</h2>
      <button class="btn-close" (click)="closeManageTagsModal()">Ã—</button>
    </div>
    <div class="modal-body">
      @if (loadingTags()) {
        <div class="loading">è¼‰å…¥ä¸­...</div>
      } @else if (availableTags().length > 0) {
        <div class="tags-management-list">
          @for (tag of availableTags(); track tag.id) {
            <div class="tag-management-item">
              <span 
                class="tag-preview" 
                [style.background-color]="tag.color"
                [style.color]="getContrastColor(tag.color)"
              >
                {{ tag.name }}
              </span>
              <div class="tag-actions">
                <button class="btn-icon" (click)="startEditTag(tag)" title="ç·¨è¼¯">
                  âœï¸
                </button>
                <button class="btn-icon btn-danger-icon" (click)="confirmDeleteTag(tag)" title="åˆªé™¤">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state">
          <p>å°šç„¡æ¨™ç±¤ï¼Œè«‹å…ˆå»ºç«‹æ¨™ç±¤</p>
        </div>
      }
    </div>
  </div>
</div>

<!-- ç·¨è¼¯æ¨™ç±¤æ¨¡æ…‹æ¡† -->
<div class="modal-overlay" *ngIf="editingTag" (click)="cancelEditTag()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ç·¨è¼¯æ¨™ç±¤</h2>
      <button class="btn-close" (click)="cancelEditTag()">Ã—</button>
    </div>
    <form (ngSubmit)="updateTag()" class="modal-form">
      <div class="form-group">
        <label for="edit-tag-name">åç¨± *</label>
        <input 
          type="text" 
          id="edit-tag-name" 
          [value]="editTagForm.name"
          (input)="onEditTagFormChange('name', $any($event.target).value)"
          name="edit-tag-name"
          required
          placeholder="è¼¸å…¥æ¨™ç±¤åç¨±"
          maxlength="100"
        />
      </div>
      <div class="form-group">
        <label for="edit-tag-color">é¡è‰²</label>
        <!-- é è¨­é¡è‰²é¸é … -->
        <div class="preset-colors">
          @for (presetColor of presetColors; track presetColor) {
            <button
              type="button"
              class="preset-color-btn"
              [class.active]="editTagForm.color === presetColor"
              [style.background-color]="presetColor"
              (click)="onEditTagFormChange('color', presetColor)"
              [title]="presetColor"
            >
              @if (editTagForm.color === presetColor) {
                <span class="check-icon">âœ“</span>
              }
            </button>
          }
        </div>
        <!-- è‡ªè¨‚é¡è‰²é¸æ“‡å™¨ -->
        <div class="color-picker-group">
          <input 
            type="color" 
            id="edit-tag-color" 
            [value]="editTagForm.color"
            (input)="onEditTagFormChange('color', $any($event.target).value)"
            name="edit-tag-color"
          />
          <input 
            type="text" 
            [value]="editTagForm.color"
            (input)="onEditTagFormChange('color', $any($event.target).value)"
            name="edit-tag-color-hex"
            placeholder="#808080"
            pattern="^#[0-9A-Fa-f]{6}$"
          />
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="cancelEditTag()">å–æ¶ˆ</button>
        <button type="submit" class="btn-primary" [disabled]="savingTag() || !editTagForm.name.trim()">
          {{ savingTag() ? 'æ›´æ–°ä¸­...' : 'æ›´æ–°' }}
        </button>
      </div>
    </form>
  </div>
</div>

