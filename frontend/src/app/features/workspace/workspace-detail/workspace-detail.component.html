<div class="workspace-detail-container">
  <main class="workspace-main" *ngIf="workspace()">
    <div class="workspace-header-info">
      <div class="workspace-title-section">
        <h1 class="workspace-title">{{ workspace()?.name || 'è¼‰å…¥ä¸­...' }}</h1>
        <p *ngIf="workspace()?.description" class="workspace-description">{{ workspace()?.description }}</p>
      </div>
      <div class="page-actions">
        <button class="btn-secondary" (click)="openMembersModal()" *ngIf="canManageMembers()">
          ğŸ‘¥ ç®¡ç†æˆå“¡
        </button>
        <button class="btn-primary" (click)="showCreateProjectModal = true">
          <span>+</span> å»ºç«‹å°ˆæ¡ˆ
        </button>
      </div>
    </div>
    <div class="workspace-info">
      <div class="info-card">
        <div class="info-item">
          <span class="info-label">æ“æœ‰è€…</span>
          <span class="info-value">{{ workspace()?.owner_name || 'æœªçŸ¥' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">å°ˆæ¡ˆæ•¸é‡</span>
          <span class="info-value">{{ workspace()?.project_count || 0 }}</span>
        </div>
        <div class="info-item info-item-with-action">
          <span class="info-label">æˆå“¡æ•¸é‡</span>
          <span class="info-value">{{ workspace()?.member_count || 0 }}</span>
        </div>
      </div>
    </div>

    <div class="projects-section">
      <div class="section-header">
        <h2>å°ˆæ¡ˆ</h2>
        <div class="filter-tabs">
          <button 
            class="tab-btn" 
            [class.active]="!showArchived"
            (click)="toggleArchived(false)"
          >
            é€²è¡Œä¸­
          </button>
          <button 
            class="tab-btn" 
            [class.active]="showArchived"
            (click)="toggleArchived(true)"
          >
            å·²å°å­˜
          </button>
        </div>
      </div>

      <div class="projects-grid" *ngIf="projects().length > 0; else emptyProjects">
        <div class="project-card" *ngFor="let project of projects()" [routerLink]="['/projects', project.id, 'board']">
          <div class="project-card-header">
            <div class="project-color" [style.background-color]="project.color"></div>
            <h3>{{ project.name }}</h3>
            <div class="project-actions" (click)="$event.stopPropagation()">
              <button class="btn-icon" (click)="editProject(project)">âœï¸</button>
              <button class="btn-icon" (click)="archiveProject(project.id, !project.is_archived)" *ngIf="canEditProject(project)">
                {{ project.is_archived ? 'ğŸ“‚' : 'ğŸ“¦' }}
              </button>
              <button class="btn-icon" (click)="deleteProject(project.id)" *ngIf="canEditProject(project)">ğŸ—‘ï¸</button>
            </div>
          </div>
          <p class="project-description" *ngIf="project.description">{{ project.description }}</p>
          <div class="project-stats">
            <div class="stat-item">
              <span class="stat-label">ä»»å‹™</span>
              <span class="stat-value">{{ project.task_count || 0 }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">å€æ®µ</span>
              <span class="stat-value">{{ project.section_count || 0 }}</span>
            </div>
          </div>
          <div class="project-footer">
            <span class="project-creator">å»ºç«‹è€…: {{ project.creator_name || 'æœªçŸ¥' }}</span>
          </div>
        </div>
      </div>

      <ng-template #emptyProjects>
        <div class="empty-state">
          <div class="empty-icon">ğŸ“‹</div>
          <h3>é‚„æ²’æœ‰å°ˆæ¡ˆ</h3>
          <p>{{ showArchived ? 'æ²’æœ‰å·²å°å­˜çš„å°ˆæ¡ˆ' : 'å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹å°ˆæ¡ˆä¾†é–‹å§‹ç®¡ç†ä»»å‹™' }}</p>
          <button class="btn-primary" (click)="showCreateProjectModal = true" *ngIf="!showArchived">
            å»ºç«‹å°ˆæ¡ˆ
          </button>
        </div>
      </ng-template>
    </div>
  </main>

  <!-- å»ºç«‹/ç·¨è¼¯å°ˆæ¡ˆæ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" *ngIf="showCreateProjectModal || editingProject" (click)="closeProjectModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingProject ? 'ç·¨è¼¯å°ˆæ¡ˆ' : 'å»ºç«‹å°ˆæ¡ˆ' }}</h2>
        <button class="btn-close" (click)="closeProjectModal()">Ã—</button>
      </div>
      <form (ngSubmit)="saveProject()" class="modal-form">
        <div class="form-group">
          <label for="name">åç¨± *</label>
          <input 
            type="text" 
            id="name" 
            [(ngModel)]="projectForm.name" 
            name="name"
            required
            placeholder="è¼¸å…¥å°ˆæ¡ˆåç¨±"
          />
        </div>
        <div class="form-group">
          <label for="description">æè¿°</label>
          <textarea 
            id="description" 
            [(ngModel)]="projectForm.description" 
            name="description"
            rows="3"
            placeholder="è¼¸å…¥å°ˆæ¡ˆæè¿°ï¼ˆé¸å¡«ï¼‰"
          ></textarea>
        </div>
        <div class="form-group">
          <label for="color">é¡è‰²</label>
          <input 
            type="color" 
            id="color" 
            [(ngModel)]="projectForm.color" 
            name="color"
          />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeProjectModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn-primary" [disabled]="loading() || !projectForm.name">
            {{ loading() ? 'è™•ç†ä¸­...' : (editingProject ? 'æ›´æ–°' : 'å»ºç«‹') }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- æˆå“¡ç®¡ç†æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" *ngIf="showMembersModal" (click)="closeMembersModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" style="max-width: 600px;">
      <div class="modal-header">
        <h2>å·¥ä½œå€æˆå“¡</h2>
        <button class="btn-close" (click)="closeMembersModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="members-actions" style="margin-bottom: 16px;">
          <button class="btn-primary" (click)="openInviteModal()" *ngIf="canManageMembers()">
            + é‚€è«‹æˆå“¡
          </button>
        </div>
        <div class="members-list" *ngIf="!loadingMembers(); else loadingMembersTemplate">
          <div class="member-item" *ngFor="let member of members()">
            <div class="member-info">
              <div class="member-avatar" *ngIf="member.avatar_url">
                <img [src]="member.avatar_url" [alt]="member.full_name" />
              </div>
              <div class="member-avatar" *ngIf="!member.avatar_url">
                {{ member.full_name.charAt(0).toUpperCase() }}
              </div>
              <div class="member-details">
                <div class="member-name">{{ member.full_name }}</div>
                <div class="member-email">{{ member.email }}</div>
              </div>
            </div>
            <div class="member-actions">
              <span class="member-role" [class.owner]="member.is_owner">
                {{ getRoleText(member.is_owner ? 'owner' : member.role) }}
              </span>
              <div class="member-controls" *ngIf="canManageMembers() && !member.is_owner">
                <select 
                  [value]="member.role" 
                  (change)="updateMemberRole(member, $any($event.target).value)"
                  class="role-select"
                  *ngIf="isOwner"
                >
                  <option value="admin">ç®¡ç†å“¡</option>
                  <option value="member">æˆå“¡</option>
                  <option value="guest">è¨ªå®¢</option>
                </select>
                <button class="btn-icon-danger" (click)="removeMember(member)" title="ç§»é™¤æˆå“¡">
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          </div>
          <div class="empty-state" *ngIf="members().length === 0">
            <p>é‚„æ²’æœ‰æˆå“¡</p>
            <button class="btn-primary" (click)="openInviteModal()" *ngIf="canManageMembers()">
              é‚€è«‹ç¬¬ä¸€å€‹æˆå“¡
            </button>
          </div>
        </div>
        <ng-template #loadingMembersTemplate>
          <div class="loading">è¼‰å…¥ä¸­...</div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- é‚€è«‹æˆå“¡æ¨¡æ…‹æ¡† -->
  <div class="modal-overlay" *ngIf="showInviteModal" (click)="closeInviteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>é‚€è«‹æˆå“¡</h2>
        <button class="btn-close" (click)="closeInviteModal()">Ã—</button>
      </div>
      <form (ngSubmit)="inviteMember()" class="modal-form">
        <div class="form-group">
          <label for="invite-email">Email *</label>
          <input 
            type="email" 
            id="invite-email" 
            [(ngModel)]="inviteForm.email" 
            name="invite-email"
            required
            placeholder="è¼¸å…¥è¦é‚€è«‹çš„ä½¿ç”¨è€… Email"
          />
          <small class="form-hint">è«‹è¼¸å…¥å·²è¨»å†Šçš„ä½¿ç”¨è€… Email</small>
        </div>
        <div class="form-group" *ngIf="isOwner">
          <label for="invite-role">è§’è‰²</label>
          <select 
            id="invite-role" 
            [(ngModel)]="inviteForm.role" 
            name="invite-role"
          >
            <option value="admin">ç®¡ç†å“¡</option>
            <option value="member">æˆå“¡</option>
            <option value="guest">è¨ªå®¢</option>
          </select>
          <small class="form-hint">
            ç®¡ç†å“¡ï¼šå¯ä»¥ç®¡ç†å°ˆæ¡ˆå’Œæˆå“¡<br>
            æˆå“¡ï¼šå¯ä»¥å»ºç«‹å’Œç·¨è¼¯å°ˆæ¡ˆ<br>
            è¨ªå®¢ï¼šåªèƒ½æŸ¥çœ‹å°ˆæ¡ˆ
          </small>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="closeInviteModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn-primary" [disabled]="loading() || !inviteForm.email.trim()">
            {{ loading() ? 'è™•ç†ä¸­...' : 'é‚€è«‹' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

